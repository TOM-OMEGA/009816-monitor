import os
import requests

def get_ai_point(summary, target_name, extra_data=None):
    gemini_key = os.environ.get('GEMINI_API_KEY')
    if not gemini_key: return "âŒ Secret éŒ¯èª¤"

    # ä½¿ç”¨æ‚¨æŒ‡å®šçš„é ‚ç´š Gemini 3 Pro é è¦½ç‰ˆ
    model_name = "gemini-3-pro-preview" 
    url = f"https://generativelanguage.googleapis.com/v1beta/models/{model_name}:generateContent?key={gemini_key}"
    
    # ğŸ’¡ 11é …å…¨ç¶­åº¦æ•¸æ“šç²¾ç¢ºæå– (è‹¥ç„¡æ•¸æ“šå‰‡é¡¯ç¤º N/A)
    # åŒ…å«ï¼šæ—¥æˆäº¤ã€Tickã€é‚„åŸåƒ¹ã€Kç·šã€PER/PBRã€5så§”è¨—ã€5sæŒ‡æ•¸ã€åŠ æ¬Šã€ç•¶æ²–ã€å ±é…¬æŒ‡æ•¸
    d = extra_data if extra_data else {}
    ext_msg = (
        f"1.åƒ¹é‡Kç·š: {d.get('k_line', 'N/A')}\n"
        f"2.å³æ™‚Tick: {d.get('tick_last', 'N/A')}\n"
        f"3.åƒ¹å€¼ä½éš: {d.get('valuation', 'N/A')}\n"
        f"4.ç›¤ä¸­5såŠ›é“: {d.get('order_strength', 'N/A')}\n"
        f"5.å¸‚å ´/å ±é…¬æŒ‡æ•¸: {d.get('market_context', 'N/A')}\n"
        f"6.å¤§ç›¤5sè„ˆå‹•: {d.get('idx_5s', 'N/A')}\n"
        f"7.ç±Œç¢¼ç©©å®š: {d.get('day_trade', 'N/A')}, æ³•äºº:{d.get('inst', 'N/A')}, å¤§æˆ¶:{d.get('holders', 'N/A')}\n"
        f"8.åŸºæœ¬é¢: {d.get('rev', 'N/A')}"
    )
    
    # é‡å°æ¨™çš„å±¬æ€§å€åˆ†ã€Œé€£å‹•ç›£æ§ã€é‡é» (ç¶­æŒç¶“ç†äººåŸå§‹é‚è¼¯)
    if "009816" in target_name:
        persona_logic = (
            "èº«åˆ†ï¼šåŸºé‡‘ç¶“ç†äºº (å®ˆè­· 2027 çµå©šåŸºé‡‘)ã€‚\n"
            "ç›£æ§ï¼šå°ç©é›»(TSM)æº¢åƒ¹ã€è²»åŠ(SOX)è£œè·Œå£“åŠ›ã€10.12 ç›®æ¨™åƒ¹åŸ·è¡Œã€‚\n"
            "æº–å‰‡ï¼šé•·ç·šæœŸæœ›å€¼ç‚ºé‡ï¼Œåš´ç¦é »ç¹äº¤æ˜“ï¼Œé‡é»åœ¨æ–¼é¢¨éšªå›æ¸¬èˆ‡æº¢åƒ¹æ”¶æ–‚ã€‚"
        )
    else:
        if "2317" in target_name or "00929" in target_name:
            focus = "ã€é‡é»ç›£æ§ï¼šTSM/SOX ç§‘æŠ€é€£å‹•ã€‘"
        else:
            focus = "ã€é‡é»ç›£æ§ï¼šå°è‚¡åŠ æ¬ŠæŒ‡æ•¸ & é‡‘èé˜²ç¦¦æ€§ã€‘"
            
        persona_logic = (
            f"èº«åˆ†ï¼šä½œè€…åŠ‰æ‰¿å½¥ã€‚æ¨™çš„ï¼š{target_name}ã€‚{focus}\n"
            "è«‹åš´å®ˆä»¥ä¸‹åæ¢å¯¦æˆ°éµå¾‹é€²è¡Œè¨ºæ–·ï¼š\n"
            "1.ã€æœŸæœ›å€¼ã€‘: ç¢ºä¿æ¨™é•·æœŸè¶¨å‹¢å‘ä¸Šï¼Œé¿é–‹ç„¡å›å½ˆåŠ›çš„å¼±å‹¢è‚¡ã€‚\n"
            "2.ã€éåŠ ç¢¼ã€‘: åš´ç¦ä¸»è§€æ”¤å¹³ï¼Œå¿…é ˆæ˜¯æœ‰è³£æ‰æœ‰è²·çš„ç¶²æ ¼å¾ªç’°ã€‚\n"
            "3.ã€è¶¨å‹¢æ¿¾ç¶²ã€‘: ç ´ 20MA/60MA ä¸”å‘ä¸‹æ™‚å±¬ç©ºé ­ï¼Œåˆ¤å®šã€ç ´ç¶²é¢¨éšªã€ï¼Œæš«ç·©è²·å…¥ã€‚\n"
            "4.ã€å‹•æ…‹é–“è·ã€‘: ä¾æ³¢å‹•åº¦èˆ‡ç¾è‚¡/å¤§ç›¤å£“åŠ›èª¿æ•´å¯¬åº¦ï¼Œé˜²æ­¢è³‡é‡‘éå¿«è€—ç›¡ã€‚\n"
            "5.ã€è³‡é‡‘æ§åˆ¶ã€‘: åš´æ§å–®ä¸€æ¨™çš„ 3,333 å…ƒä¸Šé™ï¼Œä¸å› éåº¦è£œè²¨å½±éŸ¿æœ¬é‡‘ã€‚\n"
            "6.ã€é™¤æ¯é‚„åŸã€‘: è€ƒæ…®é«˜æ¯ ETF é™¤æ¯å¾Œçš„è‚¡åƒ¹èª¿æ•´ï¼Œé¿å…èª¤è§¸è£œè²¨é»ã€‚\n"
            "7.ã€ä½æˆæœ¬ã€‘: å–„ç”¨åœ‹æ³° 1 å…ƒæ‰‹çºŒè²»ï¼Œåƒ¹å·®éœ€è¦†è“‹æˆæœ¬æ‰åŸ·è¡Œã€‚\n"
            "8.ã€æƒ…ç·’æ”¶å‰²ã€‘: RSI > 75 åˆ¤å®šæ¥µç«¯è²ªå©ªï¼Œæ‡‰æ”¶å‰²åˆ©æ½¤è€Œéè¿½é«˜ä½ˆå–®ã€‚\n"
            "9.ã€é€£å‹•é¢¨éšªã€‘: è¿½è¹¤ TSM/SOX èµ°å‹¢èˆ‡å°è‚¡å¤§ç›¤é»æ•¸ï¼Œé é˜²è·³ç©ºè£œè·Œèˆ‡æº¢åƒ¹é¢¨éšªã€‚\n"
            "10.ã€è‡ªå‹•åŒ–ã€‘: å…‹æœäººæ€§ï¼Œä¸€æ—¦é‚è¼¯ç¢ºç«‹å‰‡æ’ç¨‹åŸ·è¡Œï¼Œåš´ç¦æƒ…ç·’å¹²é ã€‚"
        )

    # å°‡ 11 é …ç²¾æº–æ•¸æ“šèˆ‡æ‚¨çš„ä»»å‹™è¦æ±‚çµåˆ
    task_description = (
        f"ã€è§’è‰²èº«åˆ†ã€‘: {persona_logic}\n"
        f"ã€æŠ€è¡“æŒ‡æ¨™æ‘˜è¦ã€‘: {summary}\n"
        f"ã€å…¨ç¶­åº¦ 11 é …å¯¦æˆ°æ•¸æ“šã€‘:\n{ext_msg}\n"
        f"ã€ä»»å‹™ã€‘: çµåˆä¸Šè¿°éµå¾‹èˆ‡å…¨ç¶­åº¦æ•¸æ“šï¼Œé‡å° {target_name} çµ¦äºˆ 150 å­—å…§è¨ºæ–·ã€‚\n"
        f"ã€è¦æ±‚ã€‘: å¿…é ˆæ˜ç¢ºçµ¦å‡ºã€åŸ·è¡Œå»ºè­°ï¼šå¯è¡Œ/ä¸å¯è¡Œ/è§€æœ›ã€ã€‚2027 å¹´è¦–è§’ï¼Œæ•¸æ“šå°å‘ï¼Œæ²ˆç©©ä¸”å…·æ¬Šå¨æ€§ã€‚"
    )

    payload = {
        "contents": [{"parts": [{"text": task_description}]}],
        "generationConfig": {"temperature": 0.7, "topP": 0.95}
    }

    try:
        res = requests.post(url, json=payload, timeout=30)
        result = res.json()
        if 'candidates' in result:
            return result['candidates'][0]['content']['parts'][0]['text']
        return "ğŸ’¡ ç³»çµ±æ ¡å°ä¸­ï¼Œè«‹ç¶­æŒç´€å¾‹ã€‚"
    except Exception as e:
        return f"âŒ AI é¡§å•é€£ç·šä¸­ï¼š({str(e)[:15]})"
